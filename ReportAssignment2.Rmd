---
title: "Assignment 2 - Report"
author: "Eleni Liarou, Zoë Azra Blei, Frederieke Loth, group 20"
date: "`r Sys.Date()`"
output:
  pdf_document:
    keep_tex: true
    latex_engine: xelatex
fontsize: 11pt
highlight: tango
---

::: {style="text-align: justify;"}
```{r setup, echo=FALSE}
options(digits = 3)
```

# Exercise 1: Titanic

#### Section a

```{r, echo=FALSE}
data_titanic <- as.data.frame(read.table("titanic.txt", header=TRUE))
data_titanic$PClass <- as.factor(data_titanic$PClass)
data_titanic$Sex <- as.factor(data_titanic$Sex)
summary(data_titanic)
```

From the summary, we see that 3rd class passengers outnumbered those in 1st and 2nd classes combined. 35% of passengers were female, and 65% male. Half the passengers were aged between 21 and 39, with 557 missing age values. The survival rate has a mean of 0.3427, indicating around one-third of passengers survived. However, the dataset is incomplete, containing data for only 1,313 of the 2,224 passengers.

```{r, fig.height=3, fig.width=8, echo=FALSE}
#syrvival rate by sex, class and age
par(mfrow = c(1, 3))

# 1. Survival Rate by Sex
sex_survival <- table(data_titanic$Sex, data_titanic$Survived)
barplot(prop.table(sex_survival, margin = 1), beside = TRUE, 
        col = c("darkred", "darkgoldenrod1"), legend = c("Died", "Survived"),
        main = "Survival Rate by Sex", ylab = "Proportion", 
        names.arg = c("Female", "Male"))  # Explicitly set labels

# 2. Survival Rate by Passenger Class
# Create the contingency table
# Create the contingency table
class_survival <- table(data_titanic$Survived, data_titanic$PClass)

# Plot the bar plot
barplot(class_survival, beside = TRUE, 
        col = c("darkred", "darkgoldenrod1"), 
        legend.text = c("Died", "Survived"),  # Correct legend labels for survival
        main = "Survival Rate by Passenger Class", 
        ylab = "Proportion", 
        names.arg = c("1st", "2nd", "3rd"),  # Set labels for passenger class
        ylim = c(0, max(class_survival) * 1.1))  # Adjust y-axis to fit data

titanic_clean <- na.omit(data_titanic)

# 3. Survival Rate by Age (Histogram)
hist(titanic_clean$Age[titanic_clean$Survived == 1], breaks = 20, col = "darkgoldenrod1", 
     main = "Age Distribution of Survivors", xlab = "Age", freq = FALSE)

# Adding the "Died" histogram on top with a transparent red color
hist(titanic_clean$Age[titanic_clean$Survived == 0], breaks = 20, col = rgb(1, 0, 0, 0.5), 
     add = TRUE, freq = FALSE)

# Legend for the plot
legend("topright", legend = c("Survived", "Died"), fill = c("darkgoldenrod1", rgb(1, 0, 0, 0.5)))

```

More males than females died, and most 3rd class passengers did not survive. The highest number of both survivors and deaths were among passengers aged 20 to 30.

From the below graphs we see that the majority of passengers were around 25 years old, with fewer individuals in older age groups. 1st class passengers were generally older than those in 2nd and 3rd class.

```{r, fig.height=3, fig.width=7, echo=FALSE}
par(mfrow = c(1, 2))
 #5. Age Distribution by Class (Boxplot)
boxplot(Age ~ PClass, data = titanic_clean, main = "Age Distribution by Class", 
        col = c("lightblue", "lightgreen", "lightpink"), ylab = "Age")

hist(data_titanic$Age, xlab="Age", main="Age Distribution of Passengers", col="coral1")
```

Let's examine how the sexes were distributed over the passenger classes.

```{r}
sex_class <-xtabs(~PClass+Sex, data=data_titanic)
sex_class
```

As expected, since there are more males overall, each passenger class has a higher number of males.

```{r}
sex_class_surv <- xtabs(Survived~PClass+Sex, data=data_titanic)
round(sex_class_surv/sex_class, 2)
```

The survival rate decreases from 1st to 3rd class, but remains significantly higher for females across all classes. However, the difference in survival between females and males is less pronounced in 3rd class.

We will now fit a logistic regression model to investigate the association between the survival status and the predictors *PClass*, *Age* and *Sex.*

```{r}
add_mod <- glm(Survived ~ PClass + Age + Sex, data = titanic_clean, family = binomial)
summary(add_mod)$coefficients
cat("AIC:", AIC(add_mod))
```

The odds can be calculated using the estimates of the above table as:

$$
\text{odds} = e^{\text{log-odds}} = e^{3.7597 + (-1.292) \times \text{PClass2nd} + (-2.521) \times \text{PClass3rd} + (-0.0392) \times \text{Age} + (-2.631) \times \text{Sexmale}} 
$$

Being in 2nd or 3rd class significantly reduces the probability of survival compared to 1st class. Older age is associated with a lower likelihood of survival, while being male significantly decreases the chances of survival compared to being female. The magnitude of the coefficients reflects the sensitivity of survival odds to each variable. Being male has the largest negative effect on survival, while age has the smallest effect in comparison to class and sex.

#### Section b

Investigating the interaction between Age and PClass.

```{r}
summary(glm(Survived~Age*PClass, data=data_titanic, family="binomial"), test="Chisq")$coefficients
cat("AIC:", AIC(glm(Survived ~ Age * PClass, data=data_titanic, family="binomial")))
```

We now investigate the interaction between Age and Sex.

```{r}
summary(glm(Survived~Age*Sex, data=data_titanic, family="binomial"), test="Chisq")$coefficients
cat("AIC:", AIC(glm(Survived ~ Age * Sex, data=data_titanic, family="binomial")))
```

The interaction between Age and PClass does not have a significant effect on survival. The p-values for both Age:PClass2nd (0.405) and Age:PClass3rd (0.771) are greater than the 0.05 threshold, indicating that these interaction terms should not be included in the final model. The interaction between Age and Sex is statistically significant, with a p-value of 1.57e-06 \< 0.05 threshold. This suggests that the relationship between Age and survival differs by Sex, and thus, the interaction term should be included in the final model.

So the final model is:

```{r}
final_model <- glm(Survived ~ PClass + Age*Sex, data=data_titanic, family="binomial")
summary(final_model, test="Chisq")$coefficients
cat("AIC:", AIC(glm(Survived ~ PClass + Age*Sex, data=data_titanic, family="binomial")))
```

This model has an AIC of 679, which is lower than the additive model’s AIC of 705. Since a lower AIC indicates a better balance between fit and complexity, we choose this model over the additive one.

Using this model, we can now estimate the probability of survival for each combination of levels of the factors PClass and *Sex* for a person of age 55.

```{r, fig.height=4}
new_data <- expand.grid(Age = 55, PClass = levels(data_titanic$PClass), 
                        Sex = levels(data_titanic$Sex))
probabilities <- predict(final_model, newdata = new_data, type = "response")
cbind(new_data, Survival_Prob = round(probabilities, 3))
```

From the table above, we see once again that being female significantly increases the chance of survival, while survival probability decreases progressively from 1st to 3rd class.

#### Section c

To predict survival status, we split the data into training (80%) and testing (20%) subsets. We train a logistic regression model using glm() on the training set and use predict() to generate survival probabilities for the test set. After applying a threshold of 0.5 we classify passengers as survived or not. The quality of the prediction can be measured by accuracy (correct predictions/total cases) and other metrics such as AUC-ROC and precision or recall, which provide a more detailed evaluation, especially when dealing with class imbalance.

#### Section d

```{r, echo=FALSE}
cont_table_class <- table(data_titanic$Survived, data_titanic$PClass)
cont_table_sex <- table(data_titanic$Survived, data_titanic$Sex)
```

We will use Fisher's exact test to examine the effect of sex on survival status since it is more suitable for 2x2 tables and the 2-test to investigate the effect of class on survival status.

```{r, echo=FALSE}
fisher.test(cont_table_sex)
```

```{r, echo=FALSE}
chisq_result <- chisq.test(cont_table_class)

# Use cat to print the message and the values
cat("We performed a 2-test to investigate the relationship between PClass and Survived.\n")

cat("Chi-squared value:", chisq_result$statistic, "Degrees of freedom:", chisq_result$parameter, "p-value:", chisq_result$p.value, "\n")
```

Both tests show that class and sex are strongly associated with survival.

The 2-test for the relationship between passenger class and survival status reveals a significant association, with a test statistic of 172 and a p-value less than 2e-16. This indicates that survival is strongly influenced by passenger class, with the null hypothesis of no association being rejected. Similarly, Fisher’s Exact Test for gender and survival status shows a highly significant result (p-value \< 2e-16). The odds ratio of 0.1 suggests that females have much higher odds of surviving than males, with a 95% confidence interval (0.0762, 0.1316) confirming that the true odds ratio is significantly less than 1. This supports the conclusion that being female substantially increases the chances of survival.

#### Section e

The approach in (d) is not wrong; it simply tests for associations between categorical variables, whereas the approach in (a) and (b) allows for adjustment of multiple factors and prediction of survival probability.

**Logistic regression**

Advantages: Can handle both categorical and continuous predictors. Provides odds ratios, making interpretation straightforward. Allows for adjustment of multiple factors simultaneously. Can be used for predicting survival probability.

Disadvantages: Assumes a linear relationship between predictor and log-odds of the outcome. Can suffer from over-fitting if the sample size is too small.

**2-Test**

Advantages: Simple and easy to compute even for large datasets. Works well for categorical explanatory variables and can be applied to tables larger than 2x2.

Disadvantages: Less accurate for small sample sizes (expected counts \< 5 can make results unreliable). Only tells you whether dependence exists, not the nature of the dependency. Cannot be used for prediction.

**Fisher Test**

same as the 2-test except for the following

Advantages: Accurate for small sample sizes. Provides exact p-value

Disadvantages: Can be used for tables larger than 2x2 but is computationally expensive.

# Exercise 2: Military Coups

```{r echo=FALSE}
library(MASS)
data <- read.table("coups.txt", header = TRUE, row.names = 1)

# Transform 'pollib' into a factor, as we think it may not have a linear effect
data$pollib <- as.factor(data$pollib)
```

#### Section a
Note that we transformed *pollib* into a factor since we hypothesized the effect to not be strictly linear. This was found to be correct after comparing the different Poisson regression model outcomes. *pollib = 1* and *pollib = 2* are henceforth compared to the value of *pollib = 0*.

``` {r echo=FALSE}
poisson_reg <- glm (miltcoup ~ ., data = data, family = poisson)
summary(poisson_reg)
```

We determine that variables for which *p-value > 0.05* do not have a statistically significant effect on our response variable *miltcoup* which signifies the number of military coups. Moreover, a positive coefficient details that an increase in the corresponding variable indicates an increase in *miltcoup*. We can therefore state the following: *oligarchy* and *parties* are statistically significant with a positive effect on *miltcoup*. *pollib1* has a slightly significant and negative effect on *miltcoup* whilst *pollib2* has a significant negative effect. We can thus say that according to the data, countries with a higher political liberation factor may experience less military coups.

#### Section b
We will now remove variables from the model one-by-one to assess which variables are significant. For clarity we will only show the last model and comment on which variables were removed.

```{r echo=FALSE}
poisson_reg1 <- glm(miltcoup ~ oligarchy + pollib + parties + pctvote + popn + size + numregim, 
                    data = data,
                    family = poisson)

poisson_reg2 <- glm(miltcoup ~ oligarchy + pollib + parties + pctvote + popn + numregim, 
                    data = data,
                    family = poisson)

poisson_reg3 <- glm(miltcoup ~ oligarchy + pollib + parties + pctvote + popn, 
                    data = data,
                    family = poisson)

poisson_reg4 <- glm(miltcoup ~ oligarchy + pollib + parties + pctvote, 
                    data = data,
                    family = poisson)
```

At each step, we removed the variable with the largest p-value for which *p-value > 0.05*. This resulted in the final poisson model with variables *oligarchy*, *pollib*, and *parties*. Although *pollib1* has a *p-value > 0.05*, we include it to properly reflect the stages within the variable.

``` {r}
# Everything p < 0.05
poisson_reg_final <- glm(miltcoup ~ oligarchy + pollib + parties, 
                    data = data,
                    family = poisson)
summary(poisson_reg_final)
```

This final version of the model is in compliance with our findings for the previously determined statistically significant variables.

#### Section c

We will now use the final model to make predictions about the mean number of coups per level of liberalization. We create a hypothetical country with mean values for the numerical variables *oligarchy*, and *parties*, while varying *pollib* for all levels (0, 1, and 2). 

``` {r echo = FALSE}
# Get all columns of which to take average
selected_vars <- c("oligarchy", "parties") 

# Compute the means
cols_means <- colMeans(data[, selected_vars])
cols_means

# Create dataset for prediction with pollib as a factor
data2 <- data.frame(pollib = factor(c(0, 1, 2), levels = levels(data$pollib)), 
                    t(cols_means))

# Make prediction
predicted_coups <- predict(poisson_reg_final, newdata = data2, type = 'response')
data.frame(pollib = c(0, 1, 2), predicted_coups = predicted_coups)

```
From this we find the mean for *oligarchy* to be *5.222* and the mean for *parties* to be *17.083*. Furthermore we find the number of predicted coups to decrease as the index for political liberalization increases. We find that our hypothetical country with no political liberalization experiences roughly *2.91* military coups, with limited rights it experiences an estimated *1.77* coups and under full political liberalization it is estimated to expect roughly *0.96* military coups. These results indicate that greater political liberalization is associated with fewer military coups.

# Exercise 3: Stormer viscometer

#### Section a

#### Section b

#### Section c

#### Section d

#### Section e
:::
